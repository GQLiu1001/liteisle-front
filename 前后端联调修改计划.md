# 轻屿记前后端联调修改计划

## 概览

基于对现有前端代码和API文档的对比分析，整理出需要修改的关键差异点，确保前后端能够顺利联调。

## 1. HTTP 基础配置调整

### 当前问题
- 现有代码使用 `/v1/` 前缀，但API文档使用 `/`
- baseURL配置需要调整

### 修改方案

**src/utils/http.ts - 基础配置调整**
```typescript
// 修改baseURL和API前缀
const http: AxiosInstance = axios.create({
  baseURL: import.meta.env.PROD ? '/api/v1' : 'http://localhost:8080/api/v1', // 统一加v1前缀
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 响应拦截器需要修改统一响应格式处理
http.interceptors.response.use(
  (response: AxiosResponse) => {
    // 根据API文档，所有响应都有统一格式：{code, message, data}
    const { code, message, data } = response.data
    if (code === 200 || code === 202) {
      return { ...response, data: { code, message, data } }
    } else {
      throw new Error(message || '请求失败')
    }
  },
  async (error) => {
    // 现有的错误处理逻辑...
  }
)
```

## 2. 认证模块 API 调整

### 当前差异分析
| 现有接口 | API文档接口 | 状态 |
|---------|------------|------|
| `POST /v1/auth/login` | `POST /auth/login` | ✅ 路径需调整 |
| `POST /v1/auth/register` | `POST /auth/register` | ✅ 需添加vcode字段 |
| `POST /v1/auth/send-verification-code` | `POST /auth/send-vcode` | ❌ 路径和参数不同 |
| `POST /v1/auth/forgot-password` | `POST /auth/forgot-password` | ✅ 字段需调整 |
| `GET /v1/auth/me` | `GET /auth/me` | ✅ 路径需调整 |
| ❌ 缺失 | `POST /auth/me/reset-password` | ❌ 需新增 |
| ❌ 缺失 | `PUT /auth/me/reset-picture` | ❌ 需新增 |

### 修改方案

**src/utils/http.ts - 认证API更新**
```typescript
export const authAPI = {
  // 登录 - 根据API文档调整
  login: (credentials: { username: string; password: string }) => {
    return post('/auth/login', credentials)
  },
  
  // 注册 - 添加vcode字段
  register: (userData: { username: string; email: string; password: string; vcode: string }) => {
    return post('/auth/register', userData)
  },
  
  // 发送验证码 - 修改为查询参数
  sendVerificationCode: (email: string) => {
    return post(`/auth/send-vcode?email=${email}`)
  },
  
  // 忘记密码 - 调整字段名
  forgotPassword: (data: { 
    username: string; 
    email: string; 
    vcode: string; 
    new_password: string; 
    confirm_password: string 
  }) => {
    return post('/auth/forgot-password', data)
  },
  
  // 获取当前用户信息
  getCurrentUser: () => {
    return get('/auth/me')
  },
  
  // 重置密码 - 新增
  resetPassword: (data: { 
    old_password: string; 
    new_password: string; 
    confirm_password: string 
  }) => {
    return post('/auth/me/reset-password', data)
  },
  
  // 更新用户头像
  updateUserPicture: (formData: FormData) => {
    return post('/auth/me/picture', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    })
  },
  
  // 重置头像 - 新增
  resetPicture: () => {
    return put('/auth/me/reset-picture')
  },
  
  // 登出
  logout: () => {
    return post('/auth/logout')
  }
}
```

## 3. 文件系统模块 API 重构

### 当前问题
- 现有API结构与文档差异较大
- 缺少批量操作支持
- 路径体系不匹配

### 修改方案

**src/utils/http.ts - 新增完整的文件系统API**
```typescript
// 文件与文件夹管理 API - 根据API文档重新设计
export const fileSystemAPI = {
  // 获取文件夹内容
  getFolderContent: (folderId: number, params?: { content?: string; sort_by?: string }) => {
    return get(`/folders/${folderId}`, { params })
  },
  
  // 创建文件夹
  createFolder: (data: { name: string; parent_id: number }) => {
    return post('/folders', data)
  },
  
  // 重命名文件
  renameFile: (fileId: number, data: { new_name: string }) => {
    return put(`/files/${fileId}/rename`, data)
  },
  
  // 重命名文件夹
  renameFolder: (folderId: number, data: { new_name: string }) => {
    return put(`/folders/${folderId}/rename`, data)
  },
  
  // 批量移动项目
  moveItems: (data: { file_ids?: number[]; folder_ids?: number[]; target_folder_id: number }) => {
    return put('/items/move', data)
  },
  
  // 批量删除项目（移入回收站）
  deleteItems: (data: { file_ids?: number[]; folder_ids?: number[] }) => {
    return del('/items', { data })
  },
  
  // 获取文件详情
  getFileDetail: (fileId: number) => {
    return get(`/files/${fileId}/detail`)
  },
  
  // 获取文件夹详情
  getFolderDetail: (folderId: number) => {
    return get(`/folders/${folderId}/detail`)
  },
  
  // 获取文件夹层级结构
  getFolderHierarchy: () => {
    return get('/folders/hierarchy')
  }
}

// 上传下载 API
export const transferAPI = {
  // 文件上传（异步处理）
  uploadFile: (file: File, folderId?: number, onProgress?: (progress: number) => void) => {
    const formData = new FormData()
    formData.append('file', file)
    if (folderId) formData.append('folder_id', folderId.toString())
    
    return post('/upload', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
      onUploadProgress: (progressEvent) => {
        if (onProgress && progressEvent.total) {
          const progress = Math.round((progressEvent.loaded * 100) / progressEvent.total)
          onProgress(progress)
        }
      }
    })
  },
  
  // 获取文件下载链接
  getFileDownloadUrl: (fileId: number) => {
    return get(`/download/file/${fileId}`)
  },
  
  // 获取文件夹下载链接
  getFolderDownloadUrl: (folderId: number) => {
    return get(`/download/folder/${folderId}`)
  },
  
  // 获取传输摘要
  getTransferSummary: () => {
    return get('/transfers/summary')
  },
  
  // 获取传输历史
  getTransferHistory: (params?: { status?: string; page?: number; size?: number }) => {
    return get('/transfers', { params })
  },
  
  // 删除传输记录
  deleteTransferLog: (logId: number, deleteFile: boolean = false) => {
    return del(`/transfers/${logId}`, { params: { delete_file: deleteFile } })
  },
  
  // 清空已完成记录
  clearCompletedTransfers: () => {
    return del('/transfers/completed')
  }
}
```

## 4. 特定视图模块 API 新增

### 当前问题
- 缺少音乐和文档的聚合查询API
- 现有Store使用mock数据

### 修改方案

**src/utils/http.ts - 新增特定视图API**
```typescript
// 音乐视图 API
export const musicAPI = {
  // 获取音乐页面数据
  getMusicPageData: (params?: { content?: string }) => {
    return get('/music', { params })
  },
  
  // 获取音乐播放链接
  getMusicPlayUrl: (fileId: number) => {
    return get(`/music/${fileId}/play`)
  }
}

// 文档视图 API
export const documentAPI = {
  // 获取文档页面数据
  getDocumentPageData: (params?: { content?: string }) => {
    return get('/documents', { params })
  },
  
  // 获取非MD文档预览链接
  getDocumentViewUrl: (fileId: number) => {
    return get(`/documents/${fileId}/view`)
  },
  
  // 获取MD文档内容
  getMarkdownContent: (fileId: number) => {
    return get(`/documents/md/${fileId}`)
  },
  
  // 保存MD文档
  saveMarkdownContent: (fileId: number, data: { content: string }) => {
    return put(`/documents/md/${fileId}`, data)
  }
}

// 回收站 API
export const recycleBinAPI = {
  // 获取回收站内容
  getRecycleBinContent: () => {
    return get('/recycle-bin')
  },
  
  // 批量还原
  restoreItems: (data: { file_ids?: number[]; folder_ids?: number[] }) => {
    return post('/recycle-bin/restore', data)
  },
  
  // 批量永久删除
  permanentDeleteItems: (data: { file_ids?: number[]; folder_ids?: number[] }) => {
    return del('/recycle-bin', { data })
  },
  
  // 清空回收站
  clearRecycleBin: () => {
    return del('/recycle-bin/all')
  }
}

// 分享功能 API
export const shareAPI = {
  // 创建分享
  createShare: (data: { 
    file_id?: number; 
    folder_id?: number; 
    is_encrypted: boolean; 
    expires_in_days: number 
  }) => {
    return post('/shares', data)
  },
  
  // 获取我的分享
  getMyShares: (params?: { page?: number; size?: number }) => {
    return get('/shares/me', { params })
  },
  
  // 取消分享
  cancelShare: (shareId: number) => {
    return del(`/shares/${shareId}`)
  }
}

// 专注功能 API - 更新现有的focusAPI
export const focusAPI = {
  // 记录专注时长
  recordFocus: (data: { focus_minutes: number }) => {
    return post('/focus/records', data)
  },
  
  // 获取专注总次数
  getTotalFocusCount: () => {
    return get('/focus/stats/total-count')
  },
  
  // 获取专注记录
  getFocusRecords: (params?: { page?: number; size?: number }) => {
    return get('/focus/stats/records', { params })
  },
  
  // 获取专注日历
  getFocusCalendar: (year: number, month: number) => {
    return get('/focus/stats/calendar', { params: { year, month } })
  }
}

// 岛屿功能 API - 更新现有的islandAPI
export const islandAPI = {
  // 获取用户岛屿收集情况
  getUserIslands: () => {
    return get('/islands/me')
  }
}
```

## 5. Store 层调整计划

### AuthStore 调整重点

**src/store/AuthStore.ts**
```typescript
// 需要调整的关键点：
1. 响应数据结构适配API文档格式：{code, message, data}
2. 更新接口调用路径
3. 添加缺失的功能（重置密码、重置头像）
4. 用户信息字段名调整（storage_used, storage_quota等）
```

### DriveStore 重构计划

**src/store/DriveStore.ts**
```typescript
// 主要变更：
1. 替换所有mock数据为真实API调用
2. 数据结构适配API文档响应格式
3. 实现批量操作方法
4. 添加异步状态管理
5. 集成WebSocket监听文件状态更新
```

### MusicStore 调整

**src/store/MusicStore.ts**
```typescript
// 关键调整：
1. 使用musicAPI.getMusicPageData()替换loadPlaylistsFromDrive()
2. 播放链接通过musicAPI.getMusicPlayUrl()获取
3. 数据结构适配API响应格式
```

## 6. WebSocket 集成

### 新增WebSocket管理

**src/utils/websocket.ts** (新建文件)
```typescript
class WebSocketManager {
  private ws: WebSocket | null = null
  private eventHandlers: Map<string, Function[]> = new Map()
  
  connect() {
    this.ws = new WebSocket('ws://localhost:8080/ws')
    
    this.ws.onmessage = (event) => {
      const { event: eventName, payload } = JSON.parse(event.data)
      this.emit(eventName, payload)
    }
  }
  
  on(eventName: string, handler: Function) {
    if (!this.eventHandlers.has(eventName)) {
      this.eventHandlers.set(eventName, [])
    }
    this.eventHandlers.get(eventName)!.push(handler)
  }
  
  emit(eventName: string, payload: any) {
    const handlers = this.eventHandlers.get(eventName) || []
    handlers.forEach(handler => handler(payload))
  }
}

export const wsManager = new WebSocketManager()
```

## 7. 类型定义更新

### API响应类型

**src/types/api.d.ts** (新建文件)
```typescript
// 统一API响应格式
export interface ApiResponse<T = any> {
  code: number
  message: string
  data: T
}

// 分页响应格式
export interface PageResponse<T> {
  total: number
  current_page: number
  page_size: number
  records: T[]
}

// 文件夹内容响应
export interface FolderContentResponse {
  folders: FolderInfo[]
  files: FileInfo[]
}

// 其他类型定义...
```

## 8. 联调测试计划

### 阶段一：基础功能（第1-2周）
1. ✅ 认证模块联调
2. ✅ 文件夹基础操作
3. ✅ 文件上传下载

### 阶段二：核心功能（第3-4周）
1. ✅ 音乐播放功能
2. ✅ 文档管理功能
3. ✅ 传输管理

### 阶段三：高级功能（第5-6周）
1. ✅ 专注和岛屿系统
2. ✅ 分享功能
3. ✅ 回收站功能
4. ✅ WebSocket实时更新

## 9. 关键注意事项

### 数据格式转换
- 所有API请求和响应都使用snake_case
- 前端内部使用camelCase
- 需要在http拦截器中处理转换

### 错误处理
- 统一使用API文档中的错误码
- 完善错误提示信息
- 添加重试机制

### 性能优化
- 实现请求去重
- 添加合适的缓存策略
- 优化大文件上传体验

### 安全考虑
- Token自动刷新机制
- 文件下载链接时效性
- XSS和CSRF防护

---

## 开始联调清单

### 立即需要修改的文件：
1. ✅ `src/utils/http.ts` - 重构所有API调用
2. ✅ `src/store/AuthStore.ts` - 适配新的认证接口
3. ✅ `src/store/DriveStore.ts` - 替换mock数据
4. ✅ `src/types/api.d.ts` - 新增类型定义
5. ✅ `src/utils/websocket.ts` - 新增WebSocket管理

### 测试重点：
1. 认证流程完整性
2. 文件上传的异步处理
3. WebSocket实时更新
4. 批量操作正确性
5. 错误处理机制

这份计划确保了前后端能够顺利对接，同时保持代码的可维护性和扩展性。 