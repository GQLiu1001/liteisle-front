# 轻屿记 (LiteIsle) 前后端接口说明书

> 本说明书基于当前前端实现（Vue 3 + Pinia + Tailwind）与产品原型编写，后端尚未落地。文档旨在为后端开发者提供**接口、参数、返回值及页面关联**的完整参考。
>
> *最后更新时间：2025-07-08*

---

## 目录
1. 全局约定
2. 页面-接口映射总览
3. 认证模块
4. 文件与文件夹模块
5. 传输管理模块
6. 音乐模块
7. 文档模块
8. 回收站模块
9. 分享模块
10. 专注与岛屿模块
11. 实时通信 (WebSocket)
12. 附录：数据库设计概览

---

## 1. 全局约定
* **协议**：全部接口使用 HTTPS；实时通信使用 WSS。
* **域名**：示例 https://api.liteisle.com
* **统一响应格式**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {...}
}
```
* **分页参数**：`page`(默认1)，`size`(默认20)。
* **鉴权**：除登陆/注册/验证码外，其余接口均需在 `Authorization` 头中携带 `Bearer <token>`。
* **命名规范**：接口层 JSON 一律 `snake_case`；后端 Java 对象采用 `camelCase` (Jackson 自动转换)。

---

## 2. 页面-接口映射总览

| 页面路径 | 主要组件 | 功能概述 | 依赖接口 |
| -------- | -------- | -------- | -------- |
| `src/pages/LoginPage.vue` | `AuthStore` | 登录 / 注册 / 忘记密码 | `POST /auth/login`, `POST /auth/register`, `POST /auth/forgot-password`, `POST /auth/send-vcode` |
| `src/pages/HomePage.vue` | `Sidebar`, `Topbar` | 首页仪表盘 | `GET /focus/total-count`, `GET /islands/me` |
| `src/pages/DrivePage.vue` | `DriveStore`, `FolderGrid`, `IsleCard` | 云盘浏览 / CRUD | `GET /folders/{id}`, `POST /folders`, `PUT /folders/{id}`, `DELETE /folders/{id}`, `POST /upload`, `DELETE /files/{id}` 等 |
| `src/pages/MusicPage.vue` | `MusicStore`, `MusicBar` | 歌曲列表及播放 | `GET /music`, `GET /music/{id}` |
| `src/pages/DocsPage.vue` | `DocsStore`, `MarkdownViewer` | 文档列表 / 阅读 / 编辑 | `GET /document`, `GET /document/{id}`, `GET /document/md/{id}`, `POST /document/md` |
| `src/pages/TransferPage.vue` | `TransferStore` | 上传/下载历史 | `GET /transfers/summary`, `GET /transfers`, `DELETE /transfers/{id}` |
| `src/pages/SettingsPage.vue` | `SettingsStore` | 账户设置 | `GET /auth/me`, `POST /auth/me/reset-password`, `POST /auth/me/picture`, `PUT /auth/me/reset-picture` |

---

下面章节按模块展开接口详细说明。

---

## 3. 认证模块

### 3.1 用户登录 `POST /auth/login`
* **请求体** (`AuthLoginReq`)
```json
{ "username": "john", "password": "123456" }
```
* **成功响应** (`AuthInfoResp`)
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "username": "john",
    "email": "john@example.com",
    "token": "<jwt>",
    "picture": "https://.../avatar.jpg"
  }
}
```
* **前端逻辑**：`AuthStore.login()` 请求成功后保存 `token` 至 `localStorage` 并初始化全局 WebSocket 连接。

### 3.2 用户注册 `POST /auth/register`
* **请求体** (`AuthRegisterReq`) 与登录类似，多 `email`、`vcode` 字段。
* **响应** 同 3.1。

### 3.3 忘记密码/验证码/登出
| 接口 | 方法 | 描述 |
| ---- | ---- | ---- |
| `/auth/send-vcode` | `POST` | 发送邮箱验证码 (`email` 为 query) |
| `/auth/forgot-password` | `POST` | 使用验证码重置密码 |
| `/auth/logout` | `POST` | 服务端清 token，前端删除本地缓存 |

---

## 4. 文件与文件夹模块

### 4.1 获取文件夹内容 `GET /folders/{folder_id}`
* **参数**：`folder_id` Long；根目录传 0。
* **示例响应** (省略部分字段)
```json
{
  "data": {
    "folders": [ { "id": 1, "name": "文档" } ],
    "files": [ { "id": 2, "name": "readme.md", "status": "available" } ]
  }
}
```
* **前端**：`DriveStore.load(folderId)` 调用；拿到后写入 Pinia 状态并渲染 `ActivityGrid`。

### 4.2 创建/重命名/移动/删除文件夹

| 接口 | 方法 | 请求体/说明 |
| ---- | ---- | -------- |
| `/folders` | `POST` | `{ "name": "新建", "parent_id": 3 }` |
| `/folders/{id}` | `PUT` | `{ "name": "改名" }` |
| `/folders/{id}/move/{target_id}` | `PUT` | 无 |
| `/folders/{id}` | `DELETE` | 软删除，移入回收站 |

### 4.3 上传文件 `POST /upload`
* **表单字段**：`file`, `folder_id(可选)`
* **返回**：`HTTP 202` + `initial_file_data`
* **异步流程**：前端立即将占位条目加入列表 → Worker 完成后触发 `file.status.updated` → `DriveStore` 更新 UI。

### 4.4 文件操作 (重命名/移动/删除)
同文件夹风格，此处略。

---

## 5. 传输管理模块

### 5.1 获取侧边栏数字 `GET /transfers/summary`
返回 `upload_count`, `download_count`。

### 5.2 获取传输记录 `GET /transfers`
* **查询**：`status=processing|completed` `page` `size`
* **返回**：包含 `records` 数组；`status` 字段定义 UI 显示。

### 5.3 删除 / 清空记录
`DELETE /transfers/{id}` & `DELETE /transfers?status=completed`

---

## 6. 音乐模块

### 6.1 获取歌单及歌曲 `GET /music`
* **返回**：`playlists`、`files`。`MusicStore.init()` 在 `MusicPage` `onMounted` 时调用。

### 6.2 播放音乐 `GET /music/{file_id}`
返回直链，Audio 标签或 Howler 播放。

---

## 7. 文档模块

### 7.1 获取文档列表 `GET /document`
`DocsStore.init()` 调用。

### 7.2 打开文档
* **非 MD**：`GET /document/{id}` 返回直链 (PDF/Word/PPT)。组件：`PDFViewer`, `WordViewer`, `PowerPointViewer`。
* **MD**：`GET /document/md/{id}` 返回 `content` + `document_url`。组件：`MarkdownViewer`，依赖 `Vditor`。

### 7.3 保存 MD `POST /document/md`
请求体：`{ "file_id": 2001, "content": "# ..." }`

---

## 8. 回收站模块

| 接口 | 方法 | 描述 |
| ---- | ---- | ---- |
| `/recycle` | `GET` | 获取 30 天内软删除内容 |
| `/recycle/{id}/restore` | `POST` | 还原 |
| `/recycle/{id}` | `DELETE` | 彻底删除 |
| `/recycle` | `DELETE` | 清空回收站 |

---

## 9. 分享模块

* **创建** `POST /shares` → 返回 `share_token` & `share_password`(可选)
* **列表** `GET /shares/me`
* **取消** `DELETE /shares/{id}`

---

## 10. 专注与岛屿模块

| 功能 | 接口 | 方法 | 说明 |
| ---- | ---- | ---- | ---- |
| 记录专注 | `/focus/{minutes}` | `POST` | 结束专注后调用；若解锁新岛屿返回 `island_id` & 图片 |
| 总次数 | `/focus/total-count` | `GET` | 首页卡片 |
| 专注日历 | `/focus/calendar?year=2024&month=7` | `GET` | 日历组件 |
| 专注记录 | `/focus/stats` | `GET` | 设置页分页列表 |
| 岛屿收集 | `/islands/me` | `GET` | 首页卡片 |

---

## 11. 实时通信 (WebSocket)

* **端点**：`wss://api.liteisle.com/ws`
* **鉴权**：建立连接时附带 `token`；示例 `wss://.../ws?token=<jwt>`
* **消息格式**：
```json
{ "event": "file.status.updated", "payload": {...} }
```
* **核心事件**
  * `file.status.updated` — 文件处理完成/失败
  * `transfer.log.updated` — 传输记录状态变更
  * `notification.new` — 系统通知 (预留)

前端在 `main.ts` 初始化 `WebSocket` 并在 Pinia Stores 中分发事件。

---

## 12. 附录：数据库设计概览

详细表结构参见 `sql/simplified_database.sql`，下表列出关键字段：

| 表 | 关键字段 | 说明 |
| -- | -------- | ---- |
| `users` | `storage_used / quota` | 用于云盘容量统计 |
| `files` | `status` | `processing / available / failed` |
| `storages` | `file_hash` | 秒传核心；`reference_count` 引用计数 |
| `transfer_log` | `status` | `processing / success / failed` |

---

> **备注**：本说明书已与现有前端状态管理及组件事件流对应，后端开发可按此快速对接。如有字段新增或变动请在 Merge Request 中同步更新此文档。 