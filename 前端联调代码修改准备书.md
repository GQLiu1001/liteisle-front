# è½»å±¿è®°å‰ç«¯è”è°ƒä»£ç ä¿®æ”¹å‡†å¤‡ä¹¦

## ğŸ“‹ APIåŠŸèƒ½è¦†ç›–å®Œæ•´æ€§ç¡®è®¤

ç»è¿‡è¯¦ç»†åˆ†æï¼Œ**APIæ–‡æ¡£å·²ç»100%è¦†ç›–äº†å‰ç«¯åº”ç”¨çš„æ‰€æœ‰åŠŸèƒ½éœ€æ±‚**ï¼š

### âœ… åŠŸèƒ½è¦†ç›–åˆ†æ
1. **è®¤è¯ç³»ç»Ÿ** - å®Œæ•´è¦†ç›–ï¼ˆåŒ…æ‹¬è®¾ç½®é¡µé¢çš„å¯†ç ä¿®æ”¹å’Œå¤´åƒé‡ç½®ï¼‰
2. **æ–‡ä»¶ç®¡ç†** - å®Œæ•´è¦†ç›–ï¼ˆç°æœ‰å¤šé€‰UIå·²å°±ç»ªï¼Œåªéœ€APIå¯¹æ¥ï¼‰
3. **éŸ³ä¹æ’­æ”¾** - å®Œæ•´è¦†ç›–ï¼ˆèšåˆæŸ¥è¯¢è®¾è®¡ä¼˜ç§€ï¼‰
4. **æ–‡æ¡£ç®¡ç†** - å®Œæ•´è¦†ç›–ï¼ˆæ”¯æŒå¤šæ ¼å¼å’ŒMDç¼–è¾‘ï¼‰
5. **ä¼ è¾“ç®¡ç†** - å®Œæ•´è¦†ç›–ï¼ˆå¼‚æ­¥ä¸Šä¼ å’Œå®æ—¶çŠ¶æ€æ›´æ–°ï¼‰
6. **ä¸“æ³¨å²›å±¿** - å®Œæ•´è¦†ç›–ï¼ˆç»Ÿè®¡å’Œæ”¶é›†åŠŸèƒ½é½å…¨ï¼‰
7. **åˆ†äº«åŠŸèƒ½** - å®Œæ•´è¦†ç›–ï¼ˆè®¾ç½®é¡µé¢å·²æœ‰åˆ†äº«ç®¡ç†UIï¼‰
8. **å›æ”¶ç«™** - å®Œæ•´è¦†ç›–ï¼ˆé¡µé¢å·²æœ‰å¯¹åº”æ“ä½œæŒ‰é’®ï¼‰

---

## ğŸ¯ æ ¸å¿ƒä¿®æ”¹ç­–ç•¥

### 1. APIè·¯å¾„ç»Ÿä¸€åŸåˆ™
- **ç»Ÿä¸€å‰ç¼€**ï¼šæ‰€æœ‰APIä½¿ç”¨ `/v1` å‰ç¼€
- **å“åº”æ ¼å¼**ï¼šç»Ÿä¸€å¤„ç† `{code, message, data}` ç»“æ„
- **å‘½åè½¬æ¢**ï¼šsnake_case â†” camelCase è‡ªåŠ¨è½¬æ¢

### 2. ç°æœ‰ä¼˜åŠ¿ä¿æŒ
- **å¤šé€‰åŠŸèƒ½å·²å®Œæ•´** - DrivePageä¸­çš„ `selectedItemIds` å·²å®ç°
- **æ‰¹é‡æ“ä½œUIå°±ç»ª** - å³é”®èœå•å·²æ”¯æŒæ‰¹é‡æ“ä½œæ˜¾ç¤º
- **WebSocketåŸºç¡€** - åªéœ€æ·»åŠ è¿æ¥å’Œäº‹ä»¶ç›‘å¬

---

## ğŸ“ è¯¦ç»†ä¿®æ”¹è®¡åˆ’

## ä¸€ã€HTTP åŸºç¡€å±‚é‡æ„ - `src/utils/http.ts`

### ğŸ”„ åŸºç¡€é…ç½®ä¿®æ”¹

```typescript
// 1. ä¿®æ”¹baseURLé…ç½®
const http: AxiosInstance = axios.create({
  baseURL: import.meta.env.PROD ? '/api/v1' : 'http://localhost:8080/api/v1',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 2. å“åº”æ‹¦æˆªå™¨ - å¤„ç†ç»Ÿä¸€å“åº”æ ¼å¼
http.interceptors.response.use(
  (response: AxiosResponse) => {
    const { code, message, data } = response.data
    if (code === 200 || code === 202) {
      return { ...response, data: { code, message, data } }
    } else {
      throw new Error(message || 'è¯·æ±‚å¤±è´¥')
    }
  },
  // ç°æœ‰é”™è¯¯å¤„ç†é€»è¾‘ä¿æŒä¸å˜...
)
```

### ğŸ”„ è®¤è¯APIé‡æ„ï¼ˆå¯¹åº”è®¾ç½®é¡µé¢åŠŸèƒ½ï¼‰

```typescript
export const authAPI = {
  // ç™»å½• - ä¿®æ”¹å‚æ•°ç»“æ„
  login: (credentials: { username: string; password: string }) => {
    return post('/auth/login', credentials)
  },
  
  // æ³¨å†Œ - æ·»åŠ vcodeå­—æ®µ
  register: (userData: { username: string; email: string; password: string; vcode: string }) => {
    return post('/auth/register', userData)
  },
  
  // å‘é€éªŒè¯ç  - ä¿®æ”¹ä¸ºæŸ¥è¯¢å‚æ•°ï¼ˆå¯¹åº”æ³¨å†Œé¡µé¢ï¼‰
  sendVerificationCode: (email: string) => {
    return post(`/auth/send-vcode?email=${email}`)
  },
  
  // å¿˜è®°å¯†ç  - è°ƒæ•´å­—æ®µå
  forgotPassword: (data: { 
    username: string; 
    email: string; 
    vcode: string; 
    new_password: string; 
    confirm_password: string 
  }) => {
    return post('/auth/forgot-password', data)
  },
  
  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  getCurrentUser: () => {
    return get('/auth/me')
  },
  
  // âœ¨ æ–°å¢ï¼šä¿®æ”¹å¯†ç ï¼ˆå¯¹åº”è®¾ç½®é¡µé¢"ä¿®æ”¹å¯†ç "æŒ‰é’®ï¼‰
  resetPassword: (data: { 
    old_password: string; 
    new_password: string; 
    confirm_password: string 
  }) => {
    return post('/auth/me/reset-password', data)
  },
  
  // æ›´æ–°ç”¨æˆ·å¤´åƒï¼ˆå¯¹åº”è®¾ç½®é¡µé¢å¤´åƒä¸Šä¼ ï¼‰
  updateUserPicture: (formData: FormData) => {
    return post('/auth/me/picture', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    })
  },
  
  // âœ¨ æ–°å¢ï¼šé‡ç½®å¤´åƒï¼ˆå¯¹åº”è®¾ç½®é¡µé¢"æ¢å¤é»˜è®¤å¤´åƒ"æŒ‰é’®ï¼‰
  resetPicture: () => {
    return put('/auth/me/reset-picture')
  },
  
  // ç™»å‡º
  logout: () => {
    return post('/auth/logout')
  }
}
```

### ğŸ”„ æ–‡ä»¶ç³»ç»ŸAPIé‡æ„ï¼ˆå¯¹åº”äº‘ç›˜é¡µé¢æ‰¹é‡æ“ä½œï¼‰

```typescript
// å®Œå…¨é‡æ„æ–‡ä»¶ç³»ç»ŸAPI
export const fileSystemAPI = {
  // è·å–æ–‡ä»¶å¤¹å†…å®¹ï¼ˆæ›¿æ¢ç°æœ‰çš„getFolderså’ŒgetFilesï¼‰
  getFolderContent: (folderId: number, params?: { content?: string; sort_by?: string }) => {
    return get(`/folders/${folderId}`, { params })
  },
  
  // åˆ›å»ºæ–‡ä»¶å¤¹
  createFolder: (data: { name: string; parent_id: number }) => {
    return post('/folders', data)
  },
  
  // é‡å‘½åæ–‡ä»¶ï¼ˆå¯¹åº”å³é”®èœå•"é‡å‘½å"ï¼‰
  renameFile: (fileId: number, data: { new_name: string }) => {
    return put(`/files/${fileId}/rename`, data)
  },
  
  // é‡å‘½åæ–‡ä»¶å¤¹ï¼ˆå¯¹åº”å³é”®èœå•"é‡å‘½å"ï¼‰
  renameFolder: (folderId: number, data: { new_name: string }) => {
    return put(`/folders/${folderId}/rename`, data)
  },
  
  // âœ¨ æ‰¹é‡ç§»åŠ¨ï¼ˆå¯¹åº”å¤šé€‰åçš„"å‰ªåˆ‡"æ“ä½œï¼‰
  moveItems: (data: { file_ids?: number[]; folder_ids?: number[]; target_folder_id: number }) => {
    return put('/items/move', data)
  },
  
  // âœ¨ æ‰¹é‡åˆ é™¤ï¼ˆå¯¹åº”å¤šé€‰åçš„"åˆ é™¤"æŒ‰é’®å’Œæ‹–æ‹½åˆ°å›æ”¶ç«™ï¼‰
  deleteItems: (data: { file_ids?: number[]; folder_ids?: number[] }) => {
    return del('/items', { data })
  },
  
  // è·å–æ–‡ä»¶è¯¦æƒ…ï¼ˆå¯¹åº”å³é”®èœå•"å±æ€§"ï¼‰
  getFileDetail: (fileId: number) => {
    return get(`/files/${fileId}/detail`)
  },
  
  // è·å–æ–‡ä»¶å¤¹è¯¦æƒ…ï¼ˆå¯¹åº”å³é”®èœå•"å±æ€§"ï¼‰
  getFolderDetail: (folderId: number) => {
    return get(`/folders/${folderId}/detail`)
  },
  
  // è·å–æ–‡ä»¶å¤¹å±‚çº§ç»“æ„ï¼ˆå¯¹åº”ç§»åŠ¨å¯¹è¯æ¡†ï¼‰
  getFolderHierarchy: () => {
    return get('/folders/hierarchy')
  }
}
```

### ğŸ†• ä¸Šä¼ ä¸‹è½½APIï¼ˆå¯¹åº”ä¼ è¾“é¡µé¢ï¼‰

```typescript
export const transferAPI = {
  // æ–‡ä»¶ä¸Šä¼ ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰- å¯¹åº”äº‘ç›˜å’ŒéŸ³ä¹é¡µé¢çš„æ–‡ä»¶ä¸Šä¼ 
  uploadFile: (file: File, folderId?: number, onProgress?: (progress: number) => void) => {
    const formData = new FormData()
    formData.append('file', file)
    if (folderId) formData.append('folder_id', folderId.toString())
    
    return post('/upload', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
      onUploadProgress: (progressEvent) => {
        if (onProgress && progressEvent.total) {
          const progress = Math.round((progressEvent.loaded * 100) / progressEvent.total)
          onProgress(progress)
        }
      }
    })
  },
  
  // è·å–æ–‡ä»¶ä¸‹è½½é“¾æ¥
  getFileDownloadUrl: (fileId: number) => {
    return get(`/download/file/${fileId}`)
  },
  
  // è·å–æ–‡ä»¶å¤¹ä¸‹è½½é“¾æ¥
  getFolderDownloadUrl: (folderId: number) => {
    return get(`/download/folder/${folderId}`)
  },
  
  // è·å–ä¼ è¾“æ‘˜è¦ï¼ˆå¯¹åº”ä¾§è¾¹æ è§’æ ‡ï¼‰
  getTransferSummary: () => {
    return get('/transfers/summary')
  },
  
  // è·å–ä¼ è¾“å†å²ï¼ˆå¯¹åº”ä¼ è¾“é¡µé¢ï¼‰
  getTransferHistory: (params?: { status?: string; page?: number; size?: number }) => {
    return get('/transfers', { params })
  },
  
  // åˆ é™¤ä¼ è¾“è®°å½•
  deleteTransferLog: (logId: number, deleteFile: boolean = false) => {
    return del(`/transfers/${logId}`, { params: { delete_file: deleteFile } })
  },
  
  // æ¸…ç©ºå·²å®Œæˆè®°å½•
  clearCompletedTransfers: () => {
    return del('/transfers/completed')
  }
}
```

### ğŸ†• ç‰¹å®šè§†å›¾APIï¼ˆéŸ³ä¹å’Œæ–‡æ¡£é¡µé¢æ•°æ®è·å–ï¼‰

```typescript
// éŸ³ä¹è§†å›¾APIï¼ˆæ›¿æ¢ç°æœ‰çš„ä»DriveStoreè·å–æ•°æ®ï¼‰
export const musicAPI = {
  // è·å–éŸ³ä¹é¡µé¢æ•°æ®ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼‰
  getMusicPageData: (params?: { content?: string }) => {
    return get('/music', { params })
  },
  
  // è·å–éŸ³ä¹æ’­æ”¾é“¾æ¥
  getMusicPlayUrl: (fileId: number) => {
    return get(`/music/${fileId}/play`)
  }
}

// æ–‡æ¡£è§†å›¾APIï¼ˆæ›¿æ¢ç°æœ‰çš„ä»DriveStoreè·å–æ•°æ®ï¼‰
export const documentAPI = {
  // è·å–æ–‡æ¡£é¡µé¢æ•°æ®ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼‰
  getDocumentPageData: (params?: { content?: string }) => {
    return get('/documents', { params })
  },
  
  // è·å–éMDæ–‡æ¡£é¢„è§ˆé“¾æ¥
  getDocumentViewUrl: (fileId: number) => {
    return get(`/documents/${fileId}/view`)
  },
  
  // è·å–MDæ–‡æ¡£å†…å®¹
  getMarkdownContent: (fileId: number) => {
    return get(`/documents/md/${fileId}`)
  },
  
  // ä¿å­˜MDæ–‡æ¡£
  saveMarkdownContent: (fileId: number, data: { content: string }) => {
    return put(`/documents/md/${fileId}`, data)
  }
}
```

### ğŸ†• å›æ”¶ç«™APIï¼ˆå¯¹åº”äº‘ç›˜é¡µé¢å›æ”¶ç«™åŠŸèƒ½ï¼‰

```typescript
export const recycleBinAPI = {
  // è·å–å›æ”¶ç«™å†…å®¹
  getRecycleBinContent: () => {
    return get('/recycle-bin')
  },
  
  // æ‰¹é‡è¿˜åŸï¼ˆå¯¹åº”å›æ”¶ç«™æ¨¡å¼ä¸‹çš„å¤šé€‰è¿˜åŸï¼‰
  restoreItems: (data: { file_ids?: number[]; folder_ids?: number[] }) => {
    return post('/recycle-bin/restore', data)
  },
  
  // æ‰¹é‡æ°¸ä¹…åˆ é™¤ï¼ˆå¯¹åº”å›æ”¶ç«™æ¨¡å¼ä¸‹çš„å¤šé€‰åˆ é™¤ï¼‰
  permanentDeleteItems: (data: { file_ids?: number[]; folder_ids?: number[] }) => {
    return del('/recycle-bin', { data })
  },
  
  // æ¸…ç©ºå›æ”¶ç«™ï¼ˆå¯¹åº”å›æ”¶ç«™é¡µé¢"ä¸€é”®åˆ é™¤"æŒ‰é’®ï¼‰
  clearRecycleBin: () => {
    return del('/recycle-bin/all')
  }
}
```

### ğŸ†• åˆ†äº«APIï¼ˆå¯¹åº”è®¾ç½®é¡µé¢åˆ†äº«ç®¡ç†ï¼‰

```typescript
export const shareAPI = {
  // åˆ›å»ºåˆ†äº«ï¼ˆå¯¹åº”å³é”®èœå•"åˆ†äº«"ï¼‰
  createShare: (data: { 
    file_id?: number; 
    folder_id?: number; 
    is_encrypted: boolean; 
    expires_in_days: number 
  }) => {
    return post('/shares', data)
  },
  
  // è·å–æˆ‘çš„åˆ†äº«ï¼ˆå¯¹åº”è®¾ç½®é¡µé¢"æˆ‘çš„åˆ†äº«"ï¼‰
  getMyShares: (params?: { page?: number; size?: number }) => {
    return get('/shares/me', { params })
  },
  
  // å–æ¶ˆåˆ†äº«ï¼ˆå¯¹åº”è®¾ç½®é¡µé¢åˆ†äº«åˆ—è¡¨çš„"å–æ¶ˆåˆ†äº«"ï¼‰
  cancelShare: (shareId: number) => {
    return del(`/shares/${shareId}`)
  }
}
```

### ğŸ”„ ä¸“æ³¨å’Œå²›å±¿APIæ›´æ–°

```typescript
// ä¸“æ³¨åŠŸèƒ½API - æ›´æ–°ç°æœ‰çš„focusAPI
export const focusAPI = {
  // è®°å½•ä¸“æ³¨æ—¶é•¿
  recordFocus: (data: { focus_minutes: number }) => {
    return post('/focus/records', data)
  },
  
  // è·å–ä¸“æ³¨æ€»æ¬¡æ•°ï¼ˆå¯¹åº”é¦–é¡µå¡ç‰‡ï¼‰
  getTotalFocusCount: () => {
    return get('/focus/stats/total-count')
  },
  
  // è·å–ä¸“æ³¨è®°å½•
  getFocusRecords: (params?: { page?: number; size?: number }) => {
    return get('/focus/stats/records', { params })
  },
  
  // è·å–ä¸“æ³¨æ—¥å†ï¼ˆå¯¹åº”é¦–é¡µæ—¥å†ç»„ä»¶ï¼‰
  getFocusCalendar: (year: number, month: number) => {
    return get('/focus/stats/calendar', { params: { year, month } })
  }
}

// å²›å±¿åŠŸèƒ½API - æ›´æ–°ç°æœ‰çš„islandAPI
export const islandAPI = {
  // è·å–ç”¨æˆ·å²›å±¿æ”¶é›†æƒ…å†µï¼ˆå¯¹åº”é¦–é¡µå²›å±¿å¡ç‰‡ï¼‰
  getUserIslands: () => {
    return get('/islands/me')
  }
}
```

---

## äºŒã€Store å±‚è°ƒæ•´è®¡åˆ’

## ğŸ”„ AuthStore è°ƒæ•´ - `src/store/AuthStore.ts`

### å…³é”®ä¿®æ”¹ç‚¹ï¼š

```typescript
// 1. å“åº”æ•°æ®é€‚é…APIæ–‡æ¡£æ ¼å¼
const login = async (credentials: LoginRequest): Promise<void> => {
  isLoading.value = true
  try {
    const response = await authAPI.login({
      username: credentials.username || credentials.email,
      password: credentials.password
    })
    
    // é€‚é…æ–°çš„å“åº”æ ¼å¼ {code, message, data}
    const { code, message, data } = response.data
    if (code === 200) {
      setAuthData({
        success: true,
        message,
        data: {
          userId: data.id,
          username: data.username,
          email: data.email,
          token: data.token,
          expiresIn: data.expiresIn || 30 * 24 * 3600
        },
        token: data.token,
        user: {
          id: data.id,
          username: data.username,
          email: data.email,
          picture: data.picture,
          storageUsed: data.storage_used,    // æ³¨æ„å­—æ®µåè½¬æ¢
          storageQuota: data.storage_quota   // æ³¨æ„å­—æ®µåè½¬æ¢
        }
      })
    } else {
      throw new Error(message || 'ç™»å½•å¤±è´¥')
    }
  } catch (error) {
    // ä¿æŒç°æœ‰çš„fallbackæ¼”ç¤ºæ¨¡å¼
    console.warn('API è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼:', error)
    // ... ç°æœ‰æ¼”ç¤ºé€»è¾‘
  } finally {
    isLoading.value = false
  }
}

// 2. æ–°å¢resetPasswordæ–¹æ³•ï¼ˆå¯¹åº”è®¾ç½®é¡µé¢ï¼‰
const resetPassword = async (data: {
  old_password: string;
  new_password: string;
  confirm_password: string;
}): Promise<void> => {
  isLoading.value = true
  try {
    const response = await authAPI.resetPassword(data)
    const { code, message } = response.data
    if (code === 200) {
      // æˆåŠŸæç¤º
      console.log('å¯†ç ä¿®æ”¹æˆåŠŸ')
    } else {
      throw new Error(message || 'å¯†ç ä¿®æ”¹å¤±è´¥')
    }
  } catch (error) {
    throw error
  } finally {
    isLoading.value = false
  }
}

// 3. æ–°å¢resetPictureæ–¹æ³•ï¼ˆå¯¹åº”è®¾ç½®é¡µé¢ï¼‰
const resetPicture = async (): Promise<void> => {
  isLoading.value = true
  try {
    const response = await authAPI.resetPicture()
    const { code, message, data } = response.data
    if (code === 200) {
      // æ›´æ–°ç”¨æˆ·å¤´åƒ
      if (user.value) {
        user.value.picture = data.new_picture_url
      }
    } else {
      throw new Error(message || 'å¤´åƒé‡ç½®å¤±è´¥')
    }
  } catch (error) {
    throw error
  } finally {
    isLoading.value = false
  }
}
```

## ğŸ”„ DriveStore é‡æ„ - `src/store/DriveStore.ts`

### æ ¸å¿ƒå˜æ›´ï¼šä»mockæ•°æ®åˆ°çœŸå®APIè°ƒç”¨

```typescript
// 1. æ•°æ®ç»“æ„é€‚é…APIå“åº”æ ¼å¼
export interface DriveItem {
  id: number
  name: string
  type: 'folder' | 'music' | 'document'  // æ”¹ä¸ºä¸APIæ–‡æ¡£ä¸€è‡´
  size?: number
  modifiedAt: string  // æ”¹ä¸ºä¸APIä¸€è‡´çš„å­—æ®µå
  createdAt: string
  path: string
  parentId: number | null
  status?: 'processing' | 'available' | 'failed'  // æ–°å¢çŠ¶æ€å­—æ®µ
  // ... å…¶ä»–å­—æ®µ
}

// 2. æ›¿æ¢getCurrentFolderContentæ–¹æ³•
const getCurrentFolderContent = async (folderId: number = 0) => {
  try {
    isLoading.value = true
    const response = await fileSystemAPI.getFolderContent(folderId, {
      content: searchQuery.value,
      sort_by: sortBy.value
    })
    
    const { code, data } = response.data
    if (code === 200) {
      // è½¬æ¢APIå“åº”åˆ°å‰ç«¯æ•°æ®æ ¼å¼
      const folders = data.folders.map(folder => ({
        id: folder.id,
        name: folder.name,
        type: 'folder' as const,
        size: 0,
        modifiedAt: folder.updated_at,
        createdAt: folder.created_at,
        path: `${currentPath.value}/${folder.name}`,
        parentId: folder.parent_id,
        itemCount: folder.sub_item_count,
        level: getCurrentLevel() + 1
      }))
      
      const files = data.files.map(file => ({
        id: file.id,
        name: file.name,
        type: file.file_type,
        size: file.file_size,
        modifiedAt: file.updated_at,
        createdAt: file.created_at,
        path: `${currentPath.value}/${file.name}`,
        parentId: file.folder_id,
        status: file.status
      }))
      
      // æ›´æ–°å½“å‰æ–‡ä»¶å¤¹å†…å®¹
      currentFolderContent.value = [...folders, ...files]
    }
  } catch (error) {
    console.error('è·å–æ–‡ä»¶å¤¹å†…å®¹å¤±è´¥:', error)
    // ä¿æŒç°æœ‰mockæ•°æ®ä½œä¸ºfallback
  } finally {
    isLoading.value = false
  }
}

// 3. å®ç°æ‰¹é‡æ“ä½œæ–¹æ³•ï¼ˆå¯¹åº”ç°æœ‰çš„å¤šé€‰UIï¼‰
const batchMoveItems = async (targetFolderId: number) => {
  const fileIds: number[] = []
  const folderIds: number[] = []
  
  // ä»selectedItemIdsä¸­åˆ†ç¦»æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
  selectedItemIds.value.forEach(id => {
    const item = findItemById(id)
    if (item?.type === 'folder') {
      folderIds.push(id)
    } else {
      fileIds.push(id)
    }
  })
  
  try {
    await fileSystemAPI.moveItems({
      file_ids: fileIds.length > 0 ? fileIds : undefined,
      folder_ids: folderIds.length > 0 ? folderIds : undefined,
      target_folder_id: targetFolderId
    })
    
    // æ¸…é™¤é€‰ä¸­çŠ¶æ€å¹¶åˆ·æ–°åˆ—è¡¨
    selectedItemIds.value.clear()
    await getCurrentFolderContent(currentFolderId.value)
  } catch (error) {
    console.error('æ‰¹é‡ç§»åŠ¨å¤±è´¥:', error)
    throw error
  }
}

const batchDeleteItems = async () => {
  const fileIds: number[] = []
  const folderIds: number[] = []
  
  selectedItemIds.value.forEach(id => {
    const item = findItemById(id)
    if (item?.type === 'folder') {
      folderIds.push(id)
    } else {
      fileIds.push(id)
    }
  })
  
  try {
    await fileSystemAPI.deleteItems({
      file_ids: fileIds.length > 0 ? fileIds : undefined,
      folder_ids: folderIds.length > 0 ? folderIds : undefined
    })
    
    selectedItemIds.value.clear()
    await getCurrentFolderContent(currentFolderId.value)
  } catch (error) {
    console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error)
    throw error
  }
}
```

## ğŸ”„ MusicStore è°ƒæ•´ - `src/store/MusicStore.ts`

### æ•°æ®æºä»DriveStoreåˆ‡æ¢åˆ°MusicAPI

```typescript
// 1. æ›¿æ¢loadPlaylistsFromDriveæ–¹æ³•
const loadMusicData = async () => {
  try {
    const response = await musicAPI.getMusicPageData({
      content: searchQuery.value
    })
    
    const { code, data } = response.data
    if (code === 200) {
      // è½¬æ¢æ’­æ”¾åˆ—è¡¨æ•°æ®
      const convertedPlaylists = data.playlists.map(playlist => ({
        id: playlist.id.toString(),
        name: playlist.name,
        tracks: [],
        folderPath: `/éŸ³ä¹/${playlist.name}`
      }))
      
      // è½¬æ¢éŸ³ä¹æ–‡ä»¶æ•°æ®å¹¶æŒ‰æ’­æ”¾åˆ—è¡¨åˆ†ç»„
      const convertedTracks = data.files.map(file => ({
        id: file.id.toString(),
        name: file.name,
        artist: file.artist || 'æœªçŸ¥è‰ºæœ¯å®¶',
        album: file.album || 'æœªçŸ¥ä¸“è¾‘',
        duration: file.duration || 0,
        filePath: `/music/${file.id}`,
        coverUrl: file.cover_art_url,
        folderId: file.folder_id
      }))
      
      // å°†éŸ³ä¹åˆ†é…åˆ°å¯¹åº”æ’­æ”¾åˆ—è¡¨
      convertedPlaylists.forEach(playlist => {
        playlist.tracks = convertedTracks.filter(track => 
          track.folderId.toString() === playlist.id
        )
      })
      
      playlists.value = convertedPlaylists
    }
  } catch (error) {
    console.error('åŠ è½½éŸ³ä¹æ•°æ®å¤±è´¥:', error)
    // ä¿æŒç°æœ‰mockæ•°æ®ä½œä¸ºfallback
  }
}

// 2. ä¿®æ”¹æ’­æ”¾URLè·å–
const playTrack = async (track: Track) => {
  try {
    const response = await musicAPI.getMusicPlayUrl(parseInt(track.id))
    const { data } = response.data
    
    // ä½¿ç”¨çœŸå®çš„æ’­æ”¾URL
    const audioUrl = data.play_url
    // ... æ’­æ”¾é€»è¾‘
  } catch (error) {
    console.error('è·å–æ’­æ”¾é“¾æ¥å¤±è´¥:', error)
    // fallbackåˆ°æœ¬åœ°è·¯å¾„
  }
}
```

---

## ä¸‰ã€WebSocket é›†æˆ - `src/utils/websocket.ts`

### æ–°å»ºWebSocketç®¡ç†å™¨

```typescript
class WebSocketManager {
  private ws: WebSocket | null = null
  private eventHandlers: Map<string, Function[]> = new Map()
  private reconnectTimer: number | null = null
  private reconnectAttempts = 0
  private maxReconnectAttempts = 5
  
  connect() {
    const wsUrl = import.meta.env.PROD ? 'wss://api.liteisle.com/ws' : 'ws://localhost:8080/ws'
    this.ws = new WebSocket(wsUrl)
    
    this.ws.onopen = () => {
      console.log('WebSocketè¿æ¥å·²å»ºç«‹')
      this.reconnectAttempts = 0
    }
    
    this.ws.onmessage = (event) => {
      const { event: eventName, payload } = JSON.parse(event.data)
      this.emit(eventName, payload)
    }
    
    this.ws.onclose = () => {
      console.log('WebSocketè¿æ¥å·²æ–­å¼€')
      this.attemptReconnect()
    }
    
    this.ws.onerror = (error) => {
      console.error('WebSocketé”™è¯¯:', error)
    }
  }
  
  on(eventName: string, handler: Function) {
    if (!this.eventHandlers.has(eventName)) {
      this.eventHandlers.set(eventName, [])
    }
    this.eventHandlers.get(eventName)!.push(handler)
  }
  
  emit(eventName: string, payload: any) {
    const handlers = this.eventHandlers.get(eventName) || []
    handlers.forEach(handler => handler(payload))
  }
  
  private attemptReconnect() {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      this.reconnectTimer = setTimeout(() => {
        this.reconnectAttempts++
        console.log(`å°è¯•é‡è¿WebSocket (${this.reconnectAttempts}/${this.maxReconnectAttempts})`)
        this.connect()
      }, 1000 * Math.pow(2, this.reconnectAttempts)) // æŒ‡æ•°é€€é¿
    }
  }
  
  disconnect() {
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer)
      this.reconnectTimer = null
    }
    if (this.ws) {
      this.ws.close()
      this.ws = null
    }
  }
}

export const wsManager = new WebSocketManager()
```

### App.vueä¸­é›†æˆWebSocket

```typescript
// src/App.vue - onMountedéƒ¨åˆ†
onMounted(async () => {
  try {
    // å¹¶è¡Œåˆå§‹åŒ–
    await Promise.all([
      authStore.initializeAuth(),
      vditorStore.initializeVditor()
    ])
    
    // å¯åŠ¨WebSocketè¿æ¥
    wsManager.connect()
    
    // ç›‘å¬æ–‡ä»¶çŠ¶æ€æ›´æ–°
    wsManager.on('file.status.updated', (payload) => {
      // æ›´æ–°DriveStoreä¸­çš„æ–‡ä»¶çŠ¶æ€
      driveStore.updateFileStatus(payload.file_id, payload.status, payload.file_data)
    })
    
    // ç›‘å¬ä¼ è¾“æ—¥å¿—æ›´æ–°
    wsManager.on('transfer.log.updated', (payload) => {
      // æ›´æ–°TransferStore
      transferStore.updateTransferStatus(payload.log_id, payload.status)
    })
    
    console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ')
  } catch (error) {
    console.warn('åº”ç”¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error)
  }
})

// æ¸…ç†WebSocketè¿æ¥
onUnmounted(() => {
  wsManager.disconnect()
})
```

---

## å››ã€æ–°å¢ç±»å‹å®šä¹‰ - `src/types/api.d.ts`

```typescript
// ç»Ÿä¸€APIå“åº”æ ¼å¼
export interface ApiResponse<T = any> {
  code: number
  message: string
  data: T
}

// åˆ†é¡µå“åº”æ ¼å¼
export interface PageResponse<T> {
  total: number
  current_page: number
  page_size: number
  records: T[]
}

// æ–‡ä»¶å¤¹å†…å®¹å“åº”
export interface FolderContentResponse {
  folders: {
    id: number
    name: string
    folder_type: 'system' | 'playlist' | 'notebook'
    sub_item_count: number
    sorted_order: number
    created_at: string
    updated_at: string
  }[]
  files: {
    id: number
    name: string
    file_type: 'music' | 'document'
    file_size: number
    status: 'processing' | 'available' | 'failed'
    sorted_order: number
    created_at: string
    updated_at: string
    artist?: string
    album?: string
    duration?: number
    cover_art_url?: string
  }[]
}

// éŸ³ä¹é¡µé¢å“åº”
export interface MusicViewResponse {
  playlists: {
    id: number
    name: string
    folder_type: 'playlist'
    sorted_order: number
    music_count: number
  }[]
  files: {
    id: number
    folder_id: number
    name: string
    file_type: 'music'
    sorted_order: number
    artist: string
    album: string
    duration: number
    cover_art_url: string
  }[]
}

// å…¶ä»–ç±»å‹å®šä¹‰...
export interface DocumentViewResponse {
  notebooks: {
    id: number
    name: string
    folder_type: 'notebook'
    sorted_order: number
    document_count: number
  }[]
  files: {
    id: number
    folder_id: number
    name: string
    file_type: 'document'
    sorted_order: number
  }[]
}
```

---

## äº”ã€é¡µé¢ç»„ä»¶è°ƒæ•´

### ğŸ”„ è®¾ç½®é¡µé¢ - `src/pages/SettingsPage.vue`

#### ä¿®æ”¹å¯†ç åŠŸèƒ½æ¥å…¥
```typescript
// ä¿®æ”¹å¯†ç å¯¹è¯æ¡†å¤„ç†é€»è¾‘
const handleChangePassword = async () => {
  if (!oldPassword.value || !newPassword.value || !confirmPassword.value) {
    toast.error('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯')
    return
  }
  
  if (newPassword.value !== confirmPassword.value) {
    toast.error('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´')
    return
  }
  
  try {
    await authStore.resetPassword({
      old_password: oldPassword.value,
      new_password: newPassword.value,
      confirm_password: confirmPassword.value
    })
    
    toast.success('å¯†ç ä¿®æ”¹æˆåŠŸ')
    showChangePasswordDialog.value = false
    // æ¸…ç©ºè¡¨å•
    oldPassword.value = ''
    newPassword.value = ''
    confirmPassword.value = ''
  } catch (error) {
    toast.error(error.message || 'å¯†ç ä¿®æ”¹å¤±è´¥')
  }
}
```

#### é‡ç½®å¤´åƒåŠŸèƒ½æ¥å…¥
```typescript
// é‡ç½®å¤´åƒæŒ‰é’®å¤„ç†é€»è¾‘
const resetUserPicture = async () => {
  try {
    await authStore.resetPicture()
    toast.success('å¤´åƒå·²é‡ç½®ä¸ºé»˜è®¤å¤´åƒ')
  } catch (error) {
    toast.error(error.message || 'å¤´åƒé‡ç½®å¤±è´¥')
  }
}
```

### ğŸ”„ äº‘ç›˜é¡µé¢ - `src/pages/DrivePage.vue`

#### æ‰¹é‡æ“ä½œåŠŸèƒ½æ¥å…¥
```typescript
// ç°æœ‰çš„selectedItemIdså·²ç»å®ç°ï¼Œåªéœ€è¦æ¥å…¥APIè°ƒç”¨

// æ‰¹é‡åˆ é™¤ï¼ˆå¯¹åº”ç°æœ‰çš„å¤šé€‰åˆ é™¤æŒ‰é’®ï¼‰
const handleBatchDelete = async () => {
  if (selectedItemIds.value.size === 0) return
  
  try {
    await driveStore.batchDeleteItems()
    toast.success(`å·²åˆ é™¤ ${selectedItemIds.value.size} ä¸ªé¡¹ç›®`)
  } catch (error) {
    toast.error('æ‰¹é‡åˆ é™¤å¤±è´¥')
  }
}

// æ‰¹é‡ç§»åŠ¨ï¼ˆå¯¹åº”ç°æœ‰çš„å‰ªåˆ‡åŠŸèƒ½ï¼‰
const handleBatchMove = async (targetFolderId: number) => {
  if (selectedItemIds.value.size === 0) return
  
  try {
    await driveStore.batchMoveItems(targetFolderId)
    toast.success(`å·²ç§»åŠ¨ ${selectedItemIds.value.size} ä¸ªé¡¹ç›®`)
  } catch (error) {
    toast.error('æ‰¹é‡ç§»åŠ¨å¤±è´¥')
  }
}
```

---

## ğŸ“‹ å®æ–½æ£€æŸ¥æ¸…å•

### ç«‹å³ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- [ ] `src/utils/http.ts` - é‡æ„æ‰€æœ‰APIè°ƒç”¨
- [ ] `src/store/AuthStore.ts` - é€‚é…æ–°è®¤è¯æ¥å£
- [ ] `src/store/DriveStore.ts` - æ›¿æ¢mockæ•°æ®
- [ ] `src/store/MusicStore.ts` - æ¥å…¥éŸ³ä¹API
- [ ] `src/types/api.d.ts` - æ–°å¢ç±»å‹å®šä¹‰
- [ ] `src/utils/websocket.ts` - æ–°å¢WebSocketç®¡ç†
- [ ] `src/App.vue` - é›†æˆWebSocket
- [ ] `src/pages/SettingsPage.vue` - æ¥å…¥å¯†ç å’Œå¤´åƒAPI
- [ ] `src/pages/DrivePage.vue` - æ¥å…¥æ‰¹é‡æ“ä½œAPI

### æµ‹è¯•éªŒè¯ï¼š
- [ ] è®¤è¯æµç¨‹ï¼ˆç™»å½•ã€æ³¨å†Œã€å¯†ç ä¿®æ”¹ï¼‰
- [ ] æ–‡ä»¶ä¸Šä¼ çš„å¼‚æ­¥å¤„ç†å’ŒWebSocketæ›´æ–°
- [ ] å¤šé€‰å’Œæ‰¹é‡æ“ä½œï¼ˆç§»åŠ¨ã€åˆ é™¤ï¼‰
- [ ] éŸ³ä¹é¡µé¢æ•°æ®åŠ è½½å’Œæ’­æ”¾
- [ ] è®¾ç½®é¡µé¢çš„å„é¡¹åŠŸèƒ½
- [ ] å›æ”¶ç«™æ“ä½œ
- [ ] åˆ†äº«åŠŸèƒ½

### æ€§èƒ½ä¼˜åŒ–ï¼š
- [ ] æ·»åŠ è¯·æ±‚å»é‡æœºåˆ¶
- [ ] å®ç°é€‚å½“çš„ç¼“å­˜ç­–ç•¥
- [ ] ä¼˜åŒ–å¤§æ–‡ä»¶ä¸Šä¼ ä½“éªŒ
- [ ] WebSocketé‡è¿æœºåˆ¶

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

å®Œæˆä»¥ä¸Šä¿®æ”¹åï¼š

1. **APIå®Œå…¨å¯¹æ¥** - æ‰€æœ‰åŠŸèƒ½ä½¿ç”¨çœŸå®åç«¯æ•°æ®
2. **å®æ—¶æ›´æ–°** - æ–‡ä»¶å¤„ç†çŠ¶æ€é€šè¿‡WebSocketå®æ—¶åé¦ˆ
3. **æ‰¹é‡æ“ä½œå®Œæ•´** - å¤šé€‰UIå·²å°±ç»ªï¼ŒAPIå¯¹æ¥å®Œæˆåå³å¯ä½¿ç”¨
4. **æ•°æ®ä¸€è‡´æ€§** - éŸ³ä¹/æ–‡æ¡£é¡µé¢æ•°æ®ä¸äº‘ç›˜ä¿æŒåŒæ­¥
5. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–** - å¼‚æ­¥å¤„ç†å‡å°‘ç­‰å¾…æ—¶é—´
6. **åŠŸèƒ½å®Œæ•´æ€§** - è®¾ç½®é¡µé¢æ‰€æœ‰åŠŸèƒ½å¯ç”¨

è¿™ä¸ªä¿®æ”¹è®¡åˆ’ç¡®ä¿äº†å‰åç«¯çš„å®Œç¾å¯¹æ¥ï¼ŒåŒæ—¶ä¿æŒäº†ç°æœ‰å‰ç«¯ä»£ç çš„ä¼˜ç§€æ¶æ„ï¼ 